name: Wazuh SSH Brute-Force Detection

on:
  push:
  pull_request:

jobs:
  test_detection:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y curl gnupg ssh jq

      - name: Install Wazuh Agent
        run: |
          curl -sO https://packages.wazuh.com/4.x/wazuh-install.sh && sudo bash wazuh-install.sh --agent

      - name: Configure Wazuh Agent
        run: |
          sudo systemctl daemon-reload
          sudo systemctl enable wazuh-agent
          sudo systemctl restart wazuh-agent
          sleep 10
          sudo systemctl status wazuh-agent --no-pager || (echo "âŒ Wazuh Agent failed to start" && exit 1)

      - name: Simulate SSH Brute-Force Attack
        run: |
          sudo bash -c 'echo "$(date "+%b %d %H:%M:%S") myserver sshd[1234]: Failed password for invalid user root from 192.168.1.200 port 22" >> /var/log/auth.log'
          sudo bash -c 'echo "$(date "+%b %d %H:%M:%S") myserver sshd[1235]: Failed password for invalid user admin from 192.168.1.200 port 22" >> /var/log/auth.log'
          sudo bash -c 'echo "$(date "+%b %d %H:%M:%S") myserver sshd[1236]: Failed password for invalid user test from 192.168.1.200 port 22" >> /var/log/auth.log'

      - name: Wait for Wazuh to Process Logs
        run: sleep 15

      - name: Verify Detection in Wazuh Alerts
        run: |
          sudo cat /var/ossec/logs/alerts/alerts.json | grep '100100' || echo "âŒ No alert found!"

      - name: Check if IP was Blocked
        run: |
          sudo iptables -L -n | grep '192.168.1.200' || echo "âŒ IP not blocked!"

      - name: Send Slack Notification on Detection
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text": "ğŸš¨ *Wazuh Alert:* SSH Brute-force attack detected!\nğŸ” Attacker IP: 192.168.1.200\nğŸ”’ Status: Blocked by Wazuh"}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}
